# Docker Compose — react-chess with all backend engines
#
# Usage:
#   docker compose up              # start all services
#   docker compose up frontend     # start frontend only (local mode)
#   docker compose up rust-backend # start a specific backend
#
# The frontend is served at http://localhost:3001
# Switch backends from the Settings panel in the UI.

services:
  # ── Frontend ────────────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3001:80"
    environment:
      - VITE_CHESS_BACKEND=local
      - VITE_CHESS_RUST_URL=http://localhost:8082
      - VITE_CHESS_GO_URL=http://localhost:8083
      - VITE_CHESS_JS_URL=http://localhost:8081
    depends_on:
      rust-backend:
        condition: service_healthy
        required: false
      go-backend:
        condition: service_healthy
        required: false
    restart: unless-stopped

  # ── Rust Backend (rust-chess) ───────────────────────────
  rust-backend:
    build:
      context: ../rust-chess
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    environment:
      - PORT=8082
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "/rust-chess", "--health-check"]
      interval: 15s
      timeout: 3s
      start_period: 5s
      retries: 3
    restart: unless-stopped

  # ── Go Backend (go-chess) ───────────────────────────────
  go-backend:
    build:
      context: ../go-chess
      dockerfile: Dockerfile
    ports:
      - "8083:8080"
    environment:
      - CHESS_HOST=0.0.0.0
      - CHESS_PORT=8080
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 15s
      timeout: 3s
      start_period: 5s
      retries: 3
    restart: unless-stopped

  # NOTE: js-backend (npm-chess) is a library, not a server —
  # no Dockerfile available.  Run it separately if needed.
